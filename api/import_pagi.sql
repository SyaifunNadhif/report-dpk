select no_rekening,nasabah_id,baki_debet,plafond,tagihan_pokok,tagihan_bunga,denda,tunggakan_pokok,tunggakan_bunga,saldo_pyad,nilai_njop,nilai_taksasi,jaminan_diperhitungkan,perc_ppapwd,nilai_ppapwd,ft_pokok,
	ft_bunga,ft_jt,kolektibilitas,my_kolek_number,reschedulling,jml_hari_pokok,jml_hari_bunga,jenis_agunan,ikatan_agunan,persen_dijaminkan,tgl_debius,saldo_debius,jml_debius,angs_debius,angsuran_ke,tanggal,
	waktu,kolektibilitas_lalu,saldo_provisi,saldo_adm_lainnya,saldo_biaya,baki_debet_rra,kode_kantor,jml_hari,pyad_harian,nilai_apht,nilai_pasar,nilai_agunan,next_tagihan_pokok,next_tagihan_bunga,tgl_mulai_macet,
	saldo_cad_restruk,saldo_bunga_ditangguhkan,tgl_mulai_nunggak,tgl_mulai_nunggak_pokok,tgl_mulai_nunggak_bunga,hari_menunggak,hari_menunggak_pokok,hari_menunggak_bunga,hari_menunggak_jt,kolektibilitas_real,my_kolek_number_real,
	tgl_mulai_nunggak_relaksasi,tgl_mulai_nunggak_pokok_relaksasi,tgl_mulai_nunggak_bunga_relaksasi,hari_menunggak_relaksasi,hari_menunggak_pokok_relaksasi,
	hari_menunggak_bunga_relaksasi from kredit_history where tanggal = '20251203' and kode_kantor between  '001' and '010'
select no_rekening,nasabah_id,baki_debet,plafond,tagihan_pokok,tagihan_bunga,denda,tunggakan_pokok,tunggakan_bunga,saldo_pyad,nilai_njop,nilai_taksasi,jaminan_diperhitungkan,perc_ppapwd,nilai_ppapwd,ft_pokok,
	ft_bunga,ft_jt,kolektibilitas,my_kolek_number,reschedulling,jml_hari_pokok,jml_hari_bunga,jenis_agunan,ikatan_agunan,persen_dijaminkan,tgl_debius,saldo_debius,jml_debius,angs_debius,angsuran_ke,tanggal,
	waktu,kolektibilitas_lalu,saldo_provisi,saldo_adm_lainnya,saldo_biaya,baki_debet_rra,kode_kantor,jml_hari,pyad_harian,nilai_apht,nilai_pasar,nilai_agunan,next_tagihan_pokok,next_tagihan_bunga,tgl_mulai_macet,
	saldo_cad_restruk,saldo_bunga_ditangguhkan,tgl_mulai_nunggak,tgl_mulai_nunggak_pokok,tgl_mulai_nunggak_bunga,hari_menunggak,hari_menunggak_pokok,hari_menunggak_bunga,hari_menunggak_jt,kolektibilitas_real,my_kolek_number_real,
	tgl_mulai_nunggak_relaksasi,tgl_mulai_nunggak_pokok_relaksasi,tgl_mulai_nunggak_bunga_relaksasi,hari_menunggak_relaksasi,hari_menunggak_pokok_relaksasi,
	hari_menunggak_bunga_relaksasi from kredit_history where tanggal = '20251203' and kode_kantor between  '011' and '020'
select no_rekening,nasabah_id,baki_debet,plafond,tagihan_pokok,tagihan_bunga,denda,tunggakan_pokok,tunggakan_bunga,saldo_pyad,nilai_njop,nilai_taksasi,jaminan_diperhitungkan,perc_ppapwd,nilai_ppapwd,ft_pokok,
	ft_bunga,ft_jt,kolektibilitas,my_kolek_number,reschedulling,jml_hari_pokok,jml_hari_bunga,jenis_agunan,ikatan_agunan,persen_dijaminkan,tgl_debius,saldo_debius,jml_debius,angs_debius,angsuran_ke,tanggal,
	waktu,kolektibilitas_lalu,saldo_provisi,saldo_adm_lainnya,saldo_biaya,baki_debet_rra,kode_kantor,jml_hari,pyad_harian,nilai_apht,nilai_pasar,nilai_agunan,next_tagihan_pokok,next_tagihan_bunga,tgl_mulai_macet,
	saldo_cad_restruk,saldo_bunga_ditangguhkan,tgl_mulai_nunggak,tgl_mulai_nunggak_pokok,tgl_mulai_nunggak_bunga,hari_menunggak,hari_menunggak_pokok,hari_menunggak_bunga,hari_menunggak_jt,kolektibilitas_real,my_kolek_number_real,
	tgl_mulai_nunggak_relaksasi,tgl_mulai_nunggak_pokok_relaksasi,tgl_mulai_nunggak_bunga_relaksasi,hari_menunggak_relaksasi,hari_menunggak_pokok_relaksasi,
	hari_menunggak_bunga_relaksasi from kredit_history where tanggal = '20251203' and kode_kantor between  '021' and '024'
select no_rekening,nasabah_id,baki_debet,plafond,tagihan_pokok,tagihan_bunga,denda,tunggakan_pokok,tunggakan_bunga,saldo_pyad,nilai_njop,nilai_taksasi,jaminan_diperhitungkan,perc_ppapwd,nilai_ppapwd,ft_pokok,
	ft_bunga,ft_jt,kolektibilitas,my_kolek_number,reschedulling,jml_hari_pokok,jml_hari_bunga,jenis_agunan,ikatan_agunan,persen_dijaminkan,tgl_debius,saldo_debius,jml_debius,angs_debius,angsuran_ke,tanggal,
	waktu,kolektibilitas_lalu,saldo_provisi,saldo_adm_lainnya,saldo_biaya,baki_debet_rra,kode_kantor,jml_hari,pyad_harian,nilai_apht,nilai_pasar,nilai_agunan,next_tagihan_pokok,next_tagihan_bunga,tgl_mulai_macet,
	saldo_cad_restruk,saldo_bunga_ditangguhkan,tgl_mulai_nunggak,tgl_mulai_nunggak_pokok,tgl_mulai_nunggak_bunga,hari_menunggak,hari_menunggak_pokok,hari_menunggak_bunga,hari_menunggak_jt,kolektibilitas_real,my_kolek_number_real,
	tgl_mulai_nunggak_relaksasi,tgl_mulai_nunggak_pokok_relaksasi,tgl_mulai_nunggak_bunga_relaksasi,hari_menunggak_relaksasi,hari_menunggak_pokok_relaksasi,
	hari_menunggak_bunga_relaksasi from kredit_history where tanggal = '20251203' and kode_kantor between  '025' and '028'


1. Insert Data 

DB BU_CORE
## kredit_history

select no_rekening,nasabah_id,baki_debet,plafond,tagihan_pokok,tagihan_bunga,denda,tunggakan_pokok,tunggakan_bunga,saldo_pyad,nilai_njop,nilai_taksasi,jaminan_diperhitungkan,perc_ppapwd,nilai_ppapwd,ft_pokok,
	ft_bunga,ft_jt,kolektibilitas,my_kolek_number,reschedulling,jml_hari_pokok,jml_hari_bunga,jenis_agunan,ikatan_agunan,persen_dijaminkan,tgl_debius,saldo_debius,jml_debius,angs_debius,angsuran_ke,tanggal,
	waktu,kolektibilitas_lalu,saldo_provisi,saldo_adm_lainnya,saldo_biaya,baki_debet_rra,kode_kantor,jml_hari,pyad_harian,nilai_apht,nilai_pasar,nilai_agunan,next_tagihan_pokok,next_tagihan_bunga,tgl_mulai_macet,
	saldo_cad_restruk,saldo_bunga_ditangguhkan,tgl_mulai_nunggak,tgl_mulai_nunggak_pokok,tgl_mulai_nunggak_bunga,hari_menunggak,hari_menunggak_pokok,hari_menunggak_bunga,hari_menunggak_jt,kolektibilitas_real,my_kolek_number_real,
	tgl_mulai_nunggak_relaksasi,tgl_mulai_nunggak_pokok_relaksasi,tgl_mulai_nunggak_bunga_relaksasi,hari_menunggak_relaksasi,hari_menunggak_pokok_relaksasi,
	hari_menunggak_bunga_relaksasi from kredit_history where tanggal = '20251203' and kode_kantor between  '001' and '028'

## tabtrans
select * from tabtrans where tgl_trans = '20251203'

## inv_history
select * from inv_history where tanggal = '20251203'

# DB DPK

## nominatif
SELECT
  k.kode_kantor AS kode_cabang,
  k.no_rekening,
  k.no_alternatif,
  k.nasabah_id,
  n.hp,
  n.tgllahir,
  n.phone_number,
  n.telpon,
  n.nama_nasabah,
  n.alamat,
  n.nama_suami_atau_istri,
  k.nama_pasangan,
  n.nama_ibu_kandung,
  n.tempat_bekerja,
  n.no_id,
  kk.deskripsi_kode_kelurahan,
  kc.deskripsi_kode_kecamatan,
  n.kodepos,
  n.gelar_h,
  n.gelar_pend,
  k.tgl_realisasi,
  k.jml_angsuran,
  k.tgl_jatuh_tempo,
  k.jml_pinjaman,
  k.jml_mark_up,
  k.type_kredit,
  k.kode_promo,
  k.suku_bunga_per_tahun,
  k.auto_debet,
  k.saldo_bunga_yad,
  k.norek_tabungan,
  k.no_spk,
  k.kode_group1,
  k.kode_group2,
  k.kode_group3,
  k.kode_group4,
  kh.saldo_provisi AS provisi_saldo,
  kh.baki_debet,
  kh.saldo_bank,
  kh.nilai_ckpn,
  kh.plafond,
  kh.tunggakan_pokok,
  kh.saldo_pyad,
  CASE
    WHEN kh.baki_debet > 0 THEN NULL
    ELSE (
      SELECT MAX(t.tgl_trans)
      FROM kretrans t
      WHERE t.no_rekening = k.no_rekening
        AND t.tgl_trans <= '20251203'
        AND FLOOR(t.my_kode_trans/100) = 3
        AND t.pokok > 0
    )
  END AS tgl_pelunasan,
  CASE
    WHEN kh.baki_debet > 0 THEN kh.tunggakan_bunga
    ELSE (
      SELECT
        COALESCE(SUM(CASE WHEN FLOOR(t.my_kode_trans/100)=2 THEN t.bunga ELSE 0 END),0)
      - COALESCE(SUM(CASE WHEN FLOOR(t.my_kode_trans/100)=3 THEN t.bunga ELSE 0 END),0)
      FROM kretrans t
      WHERE t.no_rekening = k.no_rekening
        AND t.tgl_trans <= (
          SELECT MAX(t2.tgl_trans)
          FROM kretrans t2
          WHERE t2.no_rekening = k.no_rekening
            AND t2.tgl_trans <= '20251203'
            AND FLOOR(t2.my_kode_trans/100)=3
            AND t2.pokok > 0
        )
    )
  END AS tunggakan_bunga,
  kh.tgl_mulai_nunggak,
  kh.hari_menunggak_pokok,
  kh.hari_menunggak_bunga,
  kh.hari_menunggak,
  kh.hari_menunggak_jt,
  kh.kolektibilitas,
  kh.my_kolek_number,
  kh.saldo_debius,
  kh.nilai_ppapwd,
  (
    SELECT COUNT(a.no_rekening) + 1
    FROM kredit a
    WHERE a.nasabah_id = k.nasabah_id
      AND a.no_rekening <> k.no_rekening
      AND a.tgl_realisasi < k.tgl_realisasi
  ) AS pinj_ke,
  k.kode_produk,
  kh.jenis_agunan,
  kh.ikatan_agunan,
  kh.nilai_taksasi,
  k.slik_kode_gol_penjamin,
  k.slik_kode_jenis_penggunaan,
  k.bi_sifat,
  k.kode_sumber_pelunasan,
  k.bi_gol_debitur,
  k.kode_keterkaitan,
  k.slik_kode_sektor_ekonomi,
  CASE kh.kolektibilitas
    WHEN 'L' THEN 1
    WHEN 'DP' THEN 2
    WHEN 'KL' THEN 3
    WHEN 'D' THEN 4
    WHEN 'M' THEN 5
    ELSE NULL
  END AS bobot,
  tanggal AS created
FROM kredit k
JOIN nasabah n ON n.nasabah_id = k.nasabah_id
JOIN kredit_history kh
  ON kh.no_rekening = k.no_rekening
 AND kh.tanggal = '20251203'
LEFT JOIN css_kode_dati kd
  ON kd.kode_provinsi = n.propinsi
 AND kd.kode_dati     = n.kota_kab
LEFT JOIN css_kode_kecamatan kc
  ON kc.kode_provinsi = n.propinsi
 AND kc.kode_dati     = n.kota_kab
 AND kc.kode_kecamatan= n.kecamatan
LEFT JOIN css_kode_kelurahan kk
  ON kk.kode_provinsi = n.propinsi
 AND kk.kode_dati     = n.kota_kab
 AND kk.kode_kecamatan= n.kecamatan
 AND kk.kode_kelurahan= n.desa
WHERE kh.baki_debet > 0
ORDER BY k.no_rekening;



2. Update dan Insert

# DB BU CORE

## tabel : kre_agunan
select * from kre_agunan where tgl_register > '20250901' 
## tabel : kredit
select * from kredit where tgl_realisasi > '20250901' 
## tabel : nasabah
select * from nasabah where tgl_register > '20250901' 
## tabel : kre_agunan_relasi
select * from kre_agunan_relasi where id_relasi > '578548' 

3. Delete data bulan berjalan, baru insert

# DB BU CORE

## tabel kreatrans
select * from kretrans where  month(tgl_trans) = '12' and year(tgl_trans) = '2025' and kode_kantor between '001' and '028'

# DB DPK

## transaksi_ph
SELECT
  k.kode_kantor                                    AS kode_kantor,
  k.no_rekening                                    AS no_rekening,
  n.nama_nasabah                                   AS nama_nasabah,
  t.tgl_trans                                      AS tanggal_transaksi,
  IF(t.my_kode_trans = 900, t.pokok, 0)            AS pokok,
  IF(t.my_kode_trans = 900, t.bunga, 0)            AS bunga,
  (IF(t.my_kode_trans = 900, t.pokok, 0)
   + IF(t.my_kode_trans = 900, t.bunga, 0))        AS total
FROM kredit k
JOIN kretrans t ON k.no_rekening = t.no_rekening
JOIN nasabah n ON k.nasabah_id = n.nasabah_id
WHERE
  t.tgl_trans BETWEEN '2025-12-01' AND '2025-12-03'
  AND t.my_kode_trans = 900
ORDER BY t.tgl_trans, k.no_rekening;

## transaksi_kredit
SELECT
  k.kode_kantor,
  k.no_rekening,
  k.no_alternatif,
  k.status,
  n.nama_nasabah,
  n.alamat,
  t.tgl_trans,
  t.kode_trans,
  t.kuitansi,
  k.kode_produk,
  n.gelar_h,
  n.gelar_pend,
  t.userid,
  k.kode_integrasi,
  k.kode_group1,
  k.kode_produk AS kode_produk_1,
  k.slik_kode_jenis_penggunaan,
  t.kolek,
  t.no_rekening_tabungan,
  k.kode_group2,

 
  IF(t.my_kode_trans = 100, t.pokok,        0) AS realisasi_pokok,
  IF(t.my_kode_trans = 100, t.provisi,      0) AS realisasi_provisi,
  IF(t.my_kode_trans = 100, t.materai,      0) AS realisasi_materai,
  IF(t.my_kode_trans = 100, t.premi,        0) AS realisasi_premi,
  IF(t.my_kode_trans = 100, t.notariel,     0) AS realisasi_notariel,
  IF(t.my_kode_trans = 100, t.adm_lainnya,  0) AS realisasi_adm_lainnya,
  IF(t.my_kode_trans = 100, t.tabungan,     0) AS realisasi_tabungan,

  IF(t.my_kode_trans = 300, t.pokok,        0) AS angsuran_pokok,
  IF(t.my_kode_trans = 300, t.bunga,        0) AS angsuran_bunga,
  IF(t.my_kode_trans = 300, t.bunga_yad,    0) AS angsuran_bunga_yad,
  IF(t.my_kode_trans = 300, t.denda,        0) AS angsuran_denda,
  IF(t.my_kode_trans = 300, t.disc_bunga,   0) AS diskon_bunga,
  IF(t.my_kode_trans = 300, t.adm_lainnya,  0) AS angsuran_adm_lainnya,

  t.keterangan
FROM kredit   k
JOIN kretrans t ON k.no_rekening = t.no_rekening
JOIN nasabah  n ON k.nasabah_id  = n.nasabah_id
WHERE
  t.tgl_trans BETWEEN '2025-12-01' AND '2025-12-03'
  AND FIND_IN_SET(t.kode_trans,
      '100,110,120,130,300,310,320,303,304,315,316,340,343,350') > 0
ORDER BY t.kretrans_id;


4. Truncate dan Insert

# DB DPK
## tabel : tabungan

SELECT
	tabung.no_rekening "no_rekening",
	nama_nasabah,
	tabung_history.saldo_akhir AS "saldo_akhir"
FROM
	tabung_history,
	tabung,
	nasabah 
WHERE
	tabung.no_rekening = tabung_history.no_rekening 
	AND tabung.nasabah_id = nasabah.nasabah_id 
	AND tabung_history.tanggal = "20251203"
	AND tabung_history.saldo_akhir >0
	AND tabung.kode_produk=212



